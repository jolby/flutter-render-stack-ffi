# flutter-render-stack-ffi

Common Lisp bindings to Flutter's rendering stack, enabling non-Dart UI frameworks to leverage Flutter's GPU-accelerated rendering and compositing.

## Components

This package provides bindings to two Flutter modules:

### Impeller (`%impeller` package)

GPU rendering engine providing:
- Display lists (recording and playback of drawing commands)
- Paint operations (colors, gradients, shaders)
- Path operations (lines, curves, shapes)
- Text rendering (typography, paragraphs)
- Texture management
- Vulkan/Metal/OpenGL backend abstraction

### Flow (`%flow` package)

Compositor and layer tree providing:
- Layer tree construction (hierarchical scene graph)
- Layer types: Container, Transform, Clip, Opacity, Filter, DisplayList
- **Damage tracking** (GPU-side partial repaint)
- **Raster cache** (automatic GPU texture caching for expensive subtrees)
- Frame lifecycle management

## Why This Could Be Useful

Traditional immediate-mode rendering rebuilds the entire scene every frame. Flutter's retained-mode approach:

1. **Reuses unchanged subtrees** - Skip rebuilding clean branches
2. **GPU-side damage tracking** - Only repaint changed pixels
3. **Automatic caching** - Expensive subtrees become GPU textures

This reduces CPU/GPU work for complex UIs.

## Directory Structure

```
flutter-render-stack-ffi/
├── flutter-render-stack-ffi.asd                    # Main system (depends on both binding systems)
├── flutter-render-stack-impeller-bindings.asd       # CLAW-generated Impeller binding system
├── flutter-render-stack-flow-bindings.asd           # CLAW-generated Flow binding system
├── impeller-bindings/                               # Generated Impeller bindings (per-platform)
│   ├── x86_64-pc-linux-gnu.lisp
│   ├── x86_64-apple-darwin-gnu.lisp
│   ├── x86_64-w64-mingw32.lisp
│   └── aarch64-linux-android.lisp
├── flow-bindings/                                   # Generated Flow bindings (per-platform)
│   ├── x86_64-pc-linux-gnu.lisp
│   ├── x86_64-apple-darwin-gnu.lisp
│   ├── x86_64-w64-mingw32.lisp
│   └── aarch64-linux-android.lisp
├── src/
│   ├── impeller/               # Impeller CLAW wrapper config
│   │   ├── claw-impeller.lisp  # CLAW config for binding generation
│   │   └── lib/impeller.h      # C API header
│   └── flow/                   # Flow CLAW wrapper config
│       ├── claw-flow.lisp      # CLAW config for binding generation
│       └── lib/flow.h          # C API header
├── lib/                        # Native libraries (runtime)
│   ├── libimpeller.so
│   └── libflow.so
└── example/
    └── example.lisp
```

## Generating / Regenerating Bindings

Bindings are generated by CLAW from the C API headers. To regenerate:

```lisp
;; 1. Enable CLAW adapter regeneration
(pushnew :claw-regen-adapter *features*)

;; 2. Load libresect (CLAW's C header parser)
(cffi:load-foreign-library
  (merge-pathnames ".local/lib/libresect.so" (user-homedir-pathname)))

;; 3. Load the CLAW wrapper generators (force reload to pick up changes)
(ql:quickload :flutter-render-stack-ffi/gen-impeller :force t)
(ql:quickload :flutter-render-stack-ffi/gen-flow :force t)

;; 4. Generate the bindings
(claw:load-wrapper :flutter-render-stack-ffi/impeller)
(claw:load-wrapper :flutter-render-stack-ffi/flow)
```

This writes platform-specific binding files to `impeller-bindings/` and `flow-bindings/`, along with the corresponding `.asd` system definitions.

## Usage

```lisp
;; Load both Impeller and Flow bindings
(ql:quickload :flutter-render-stack-ffi)

;; Create a display list with Impeller
(let ((dl-builder (%impeller:display-list-builder-new nil)))
  (unwind-protect
       (progn
         ;; Draw operations...
         (%impeller:display-list-builder-draw-rect dl-builder rect paint)
         (let ((dl (%impeller:display-list-builder-build dl-builder)))

           ;; Wrap in Flow layer tree
           (let* ((offset (cffi:foreign-alloc '(:struct %flow:point)))
                  (layer (%flow:display-list-layer-new offset dl)))
             ;; Add to layer tree for compositing...
             )))
    (%impeller:display-list-builder-release dl-builder)))
```

## Requirements

- Common Lisp implementation with CFFI support
- CLAW (for binding generation only)
- `libresect.so` (for binding generation only)
- `libimpeller.so` and `libflow.so` (runtime, from Flutter engine build)

## Building the Native Libraries

The native libraries must be built from the Flutter engine. See the parent project's documentation for build instructions.

## Version

This package tracks Flutter engine version via tags:
- `flow-interop-v0.2.0` - Phase 1b complete (all layer types, damage tracking, raster cache)

## License

BSD-3-Clause (matching Flutter engine license)
